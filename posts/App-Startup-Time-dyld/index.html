<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="layout-lang" content="zh-CN"><meta name="day-prompt" content="d ago"><meta name="hour-prompt" content="hr ago"><meta name="minute-prompt" content="min ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="【WWDC17】优化 APP 启动（dyld 2 -&gt; dyld 3）" /><meta name="author" content="BOB" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="BOB BOB BOB 开坦克的 BOB 。" /><meta property="og:description" content="BOB BOB BOB 开坦克的 BOB 。" /><link rel="canonical" href="https://huang-libo.github.io/posts/App-Startup-Time-dyld/" /><meta property="og:url" content="https://huang-libo.github.io/posts/App-Startup-Time-dyld/" /><meta property="og:site_name" content="BOB’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-07T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="【WWDC17】优化 APP 启动（dyld 2 -&gt; dyld 3）" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@BOB" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"BOB"},"description":"BOB BOB BOB 开坦克的 BOB 。","url":"https://huang-libo.github.io/posts/App-Startup-Time-dyld/","@type":"BlogPosting","headline":"【WWDC17】优化 APP 启动（dyld 2 -&gt; dyld 3）","dateModified":"2021-12-08T13:25:54+08:00","datePublished":"2021-07-07T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://huang-libo.github.io/posts/App-Startup-Time-dyld/"},"@context":"https://schema.org"}</script><title>【WWDC17】优化 APP 启动（dyld 2 -> dyld 3） | BOB's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="BOB's blog"><meta name="application-name" content="BOB's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/favicon.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">BOB's blog</a></div><div class="site-subtitle font-italic">Just for Fun!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Huang-Libo" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['LiboHwang+IM','gmail.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-5" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>【WWDC17】优化 APP 启动（dyld 2 -> dyld 3）</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>【WWDC17】优化 APP 启动（dyld 2 -> dyld 3）</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Huang Libo </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jul 7, 2021, 12:00 AM +0800" >Jul 7<i class="unloaded">2021-07-07T00:00:00+08:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Dec 8, 2021, 1:25 PM +0800" >Dec 8<i class="unloaded">2021-12-08T13:25:54+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4782 words">26 minread</span></div></div><div class="post-content"><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-cover.jpeg" alt="dyld-cover.jpeg" /></p><p><h2>目录</h2></p><ul><li><a href="#前言">前言</a><li><a href="#术语">术语</a><ul><li><a href="#darwin-里的-dyld-的全称">Darwin 里的 dyld 的全称</a><li><a href="#启动时间-startup-time">启动时间 (Startup Time)</a><li><a href="#启动闭包-launch-closure">启动闭包 (Launch Closure)</a></ul><li><a href="#回顾-wwdc16优化-app-启动的建议">回顾 WWDC16：优化 APP 启动的建议</a><ul><li><a href="#减少启动阶段的任务">减少启动阶段的任务</a><li><a href="#多使用-swift">多使用 Swift</a></ul><li><a href="#instruments-static-initializer-tracing">Instruments: Static initializer tracing</a><li><a href="#dyld-简史">dyld 简史</a><ul><li><a href="#dyld-10-19962004">dyld 1.0 (1996–2004)</a><li><a href="#dyld-20-20042007">dyld 2.0 (2004–2007)</a><ul><li><a href="#1-dyld-20-的改进速度和语义">1. dyld 2.0 的改进：速度和语义</a><li><a href="#2-不足健全性检验比较有限">2. 不足：健全性检验比较有限</a></ul><li><a href="#dyld-2x-20072017">dyld 2.x (2007–2017)</a><ul><li><a href="#1-支持了更多的架构和系统">1. 支持了更多的架构和系统</a><li><a href="#2-提高了安全性">2. 提高了安全性</a><li><a href="#3-优化了性能">3. 优化了性能</a></ul><li><a href="#共享缓存-shared-cache">共享缓存 (Shared Cache)</a><ul><li><a href="#优化方式">优化方式</a><ul><li><a href="#1-重新排列二进制文件-rearranges-binaries-以提高加载速度">1. 重新排列二进制文件 (Rearranges binaries) 以提高加载速度</a><li><a href="#2-预链接动态库-pre-links-dylibs">2. 预链接动态库 (Pre-links dylibs)</a><li><a href="#3-预构建-pre-builds-dyld-和-objc-使用的数据结构">3. 预构建 (Pre-builds) dyld 和 ObjC 使用的数据结构</a></ul><li><a href="#共享缓存的生成方式">共享缓存的生成方式</a></ul><li><a href="#dyld-3-2017">dyld 3 (2017)</a></ul><li><a href="#dyld-3-诞生的背景">dyld 3 诞生的背景</a><ul><li><a href="#为什么又重写动态链接器">为什么又重写动态链接器</a><li><a href="#无法使用-xctest-测试-dyld-2x-代码的原因">无法使用 XCTest 测试 dyld 2.x 代码的原因</a><li><a href="#dyld-3-的改进">dyld 3 的改进</a></ul><li><a href="#dyld-2-的执行流程">dyld 2 的执行流程</a><ul><li><a href="#1-parse-mach-o-headers--find-dependencies">1. Parse mach-o headers &amp; Find dependencies</a><li><a href="#2-map-mach-o-files">2. Map mach-o files</a><li><a href="#3-perform-symbol-lookups">3. Perform symbol lookups</a><li><a href="#4-bind-and-rebase">4. Bind and rebase</a><li><a href="#5-run-initializers">5. Run initializers</a></ul><li><a href="#dyld-2-向-dyld-3-的转变">dyld 2 向 dyld 3 的转变</a><ul><li><a href="#1-安全敏感组件">1. 安全敏感组件</a><li><a href="#2-可缓存的部分">2. 可缓存的部分</a></ul><li><a href="#dyld-3-架构简介">dyld 3 架构简介</a><ul><li><a href="#概览dyld-3-由三部分组成">概览：dyld 3 由三部分组成</a><li><a href="#1-进程外的-mach-o-解析器编译器">1. 进程外的 mach-o 解析器/编译器</a><li><a href="#2-运行启动闭包的进程内引擎">2. 运行启动闭包的进程内引擎</a><li><a href="#3-启动闭包缓存服务">3. 启动闭包缓存服务</a></ul><li><a href="#为-dyld-3-做准备">为 dyld 3 做准备</a><ul><li><a href="#潜在的问题">潜在的问题</a><li><a href="#__data-中未对齐的指针">__DATA 中未对齐的指针</a><li><a href="#急切的符号解析">急切的符号解析</a><ul><li><a href="#1-dyld-2-执行惰性的符号解析-lazy-symbol-resolution">1. dyld 2 执行惰性的符号解析 (Lazy symbol resolution)</a><li><a href="#2-dyld-3-执行急切的符号解析-eager-symbol-resolution">2. dyld 3 执行急切的符号解析 (Eager symbol resolution)</a><li><a href="#3-dyld-3-对符号缺失的兼容">3. dyld 3 对符号缺失的兼容</a><li><a href="#4-linker-flag--bind_at_load">4. Linker Flag: -bind_at_load</a></ul><li><a href="#dlopen--dlsym--dladdr">dlopen() / dlsym() / dladdr()</a><li><a href="#dlclose">dlclose()</a><li><a href="#all_image_infos">all_image_infos</a><li><a href="#最佳实践">最佳实践</a></ul><li><a href="#应用场景">应用场景</a><ul><li><a href="#prepare-your-app-for-prewarming">Prepare Your App for Prewarming</a></ul><li><a href="#reference">Reference</a></ul><h2 id="前言">前言</h2><p><a href="https://developer.apple.com/videos/play/wwdc2017/413/">WWDC17 - Session413: &lt;App Startup Time: Past, Present, and Future&gt;</a> 详细介绍了 <code class="language-plaintext highlighter-rouge">dyld</code> ，并给出了 APP 启动优化相关的建议。演讲者来自 <em>dyld Team</em> 。</p><h2 id="术语">术语</h2><h3 id="darwin-里的-dyld-的全称">Darwin 里的 dyld 的全称</h3><blockquote><p>一些博文在介绍 <code class="language-plaintext highlighter-rouge">dyld</code> 时，把它的英文全称写错了，那个全称是 <code class="language-plaintext highlighter-rouge">FreeBSD</code> 上使用的。这里为了防止大家记成错的，就不提那个名称了。</p><p>虽然 <code class="language-plaintext highlighter-rouge">Darwin</code> 的内核也用了 <code class="language-plaintext highlighter-rouge">FreeBSD</code> 的一部分，但随着版本的迭代，已对 <code class="language-plaintext highlighter-rouge">dyld</code> 已有了自己的解释。</p></blockquote><p>在终端使用 <code class="language-plaintext highlighter-rouge">man dyld</code> 查看文档，可看出其全称是 <strong>the dynamic linker</strong> ：</p><p><img data-proofer-ignore data-src="/images/WWDC/Common/man-dyld.jpg" alt="man-dyld.jpg" /></p><h3 id="启动时间-startup-time">启动时间 (Startup Time)</h3><blockquote><p>说明：通常意义上的启动时间也包括 <code class="language-plaintext highlighter-rouge">main()</code> 之后的一部分时间，但本演讲只涉及 <code class="language-plaintext highlighter-rouge">main()</code> 之前的时间。</p></blockquote><p>这个演讲的<em>启动时间</em>是指 <code class="language-plaintext highlighter-rouge">main()</code> 之前的时间，并讲解如何加快这个阶段的启动速度。</p><h3 id="启动闭包-launch-closure">启动闭包 (Launch Closure)</h3><p>启动闭包指<strong>启动一个 APP 所需要的所有信息</strong>。比如：</p><ul><li>APP 使用了哪些 <strong>dylib</strong> 。<li>APP 内使用的各种<strong>符号 (symbols) 的偏移量 (offsets)</strong> 。<li>APP 的<strong>代码签名 (code signatures)</strong> 的位置。</ul><h2 id="回顾-wwdc16优化-app-启动的建议">回顾 WWDC16：优化 APP 启动的建议</h2><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/wwdc16-advice.jpeg" alt="wwdc16-advice.jpeg" /></p><h3 id="减少启动阶段的任务">减少启动阶段的任务</h3><ul><li>减少<em>嵌入的 (Embed)</em> <code class="language-plaintext highlighter-rouge">dylib</code> 的数量。<li>减少声明的 <code class="language-plaintext highlighter-rouge">classes/methods</code> 的数量。<li>少用 <code class="language-plaintext highlighter-rouge">initializers</code> 。</ul><h3 id="多使用-swift">多使用 Swift</h3><p><code class="language-plaintext highlighter-rouge">Swift</code> 语言的设计避开了 <code class="language-plaintext highlighter-rouge">C</code> , <code class="language-plaintext highlighter-rouge">C++</code> 和 <code class="language-plaintext highlighter-rouge">Objective-C</code> 中的许多隐患。</p><ul><li><code class="language-plaintext highlighter-rouge">Swift</code> 没有 <code class="language-plaintext highlighter-rouge">initializer</code> 。<li><code class="language-plaintext highlighter-rouge">Swift</code> 改善了大小。<li><code class="language-plaintext highlighter-rouge">Swift</code> 不允许存在<em>未对齐的（misaligned）</em>数据结构，未对齐的数据结构会在启动时消耗额外的时间。</ul><p>相关 Session ：</p><ul><li><a href="https://developer.apple.com/videos/play/wwdc2016/406/">WWDC16 - Session406: &lt;Optimizing App Startup Time&gt;</a><ul><li>(链接已打不开，不知为何下掉了，但在 <a href="https://wwdc.io">wwdc.io</a> 的 macOS 应用中可以查看)</ul></ul><h2 id="instruments-static-initializer-tracing">Instruments: Static initializer tracing</h2><p><em>静态初始化器 (Static Initializer)</em>的代码在 <code class="language-plaintext highlighter-rouge">main()</code> 之前调用，而开发者对 <code class="language-plaintext highlighter-rouge">main()</code> 之前发生的事缺乏可视的观测方式。</p><p><em>iOS 11</em> 和 <em>macOS High Sierra</em> 的内核与 <code class="language-plaintext highlighter-rouge">dyld</code> 中新增了相关基础设施 (infrastructure) ，因此可使用 Instruments 中新增的 <strong>Static Initializer Calls</strong> 为每个<em>静态初始化器</em> 提供精确的计时：</p><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/Instruments-Static-Initializer-Tracing.jpeg" alt="Instruments-Static-Initializer-Tracing.jpeg" class="normal" width="350" /></p><p>添加方式：</p><ul><li>Instruments<ul><li>Blank（空模板）<ul><li>点击右上角的 <code class="language-plaintext highlighter-rouge">+</code> 按钮<ul><li>在弹出的页面中搜索 <strong>Static Initializer Calls</strong>，双击即可添加<li>可搭配 <strong>Time Profiler</strong> 使用（也是搜索后双击添加）</ul></ul></ul></ul><h2 id="dyld-简史">dyld 简史</h2><h3 id="dyld-10-19962004">dyld 1.0 (1996–2004)</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-1.0.jpeg" alt="dyld-1.0.jpeg" /></p><p>早在 1996 年，<code class="language-plaintext highlighter-rouge">dyld 1</code> 就作为 <code class="language-plaintext highlighter-rouge">NeXTStep 3.3</code> 的一部分发布了。在这之前，<code class="language-plaintext highlighter-rouge">NeXTStep</code> 使用静态库。</p><p>这个时间早于 <strong>POSIX</strong> <code class="language-plaintext highlighter-rouge">dlopen()</code> 标准颁布的时间，大多数系统也还未使用大型 <code class="language-plaintext highlighter-rouge">C++</code> 动态库。</p><p>当时，由于和其他的 <code class="language-plaintext highlighter-rouge">Unix</code> 系统的实现不太一样，因此人们在 <code class="language-plaintext highlighter-rouge">macOS 10</code> 的早期版本上编写<em>第三方包装程序 (third-party wrappers)</em> ，以支持标准的 <code class="language-plaintext highlighter-rouge">Unix</code> 软件。</p><p>发布 <em>macOS Cheetah (10.0)</em> 时，在 <code class="language-plaintext highlighter-rouge">dyld 1</code> 中引入了 <em>Prebinding</em> 技术，它虽然可以加快启动速度，但有安全隐患，因为 <em>Prebinding</em> 会修改应用二进制文件。详情请看 <a href="https://github.com/Bob-Playground/WWDC-Stuff/blob/master/2017/413-App-Startup-Time-Past-Present-and-Future/Transcript-Edited.md#prebinding">字幕中 Prebinding 的简介</a>。</p><h3 id="dyld-20-20042007">dyld 2.0 (2004–2007)</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-2.0.jpeg" alt="dyld-2.0.jpeg" /></p><p><code class="language-plaintext highlighter-rouge">dyld 2.0</code> 是作为 <code class="language-plaintext highlighter-rouge">macOS Tiger (10.4)</code> 的一部分发布的，是对 <code class="language-plaintext highlighter-rouge">dyld</code> 的完全重写。</p><h4 id="1-dyld-20-的改进速度和语义">1. dyld 2.0 的改进：速度和语义</h4><ul><li>正确地支持了 <code class="language-plaintext highlighter-rouge">C++</code> <em>初始化器</em>的语义，因此可以得到高效的 <code class="language-plaintext highlighter-rouge">C++</code> 库支持。<li>有语义正确的、完全 <em>native</em> 的 <code class="language-plaintext highlighter-rouge">dlopen</code> 和 <code class="language-plaintext highlighter-rouge">dlsym</code> 。<li>由于速度得到了提升，因此减少了 <code class="language-plaintext highlighter-rouge">prebinding</code>，只有系统库会执行 <code class="language-plaintext highlighter-rouge">prebinding</code>，且只会在系统升级的时候执行。</ul><h4 id="2-不足健全性检验比较有限">2. 不足：健全性检验比较有限</h4><p><code class="language-plaintext highlighter-rouge">dyld 2.0</code> 是为速度提升设计的，因此<em>健全性检测 (sanity checking)</em>比较有限，存在一些安全性问题。但那个年代的（针对 Apple 系统的）恶意软件比较少。</p><h3 id="dyld-2x-20072017">dyld 2.x (2007–2017)</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-2.x.jpeg" alt="dyld-2.x.jpeg" /></p><p>在这个时期，<code class="language-plaintext highlighter-rouge">dyld 2.x</code> 做了多项显著的改进。</p><h4 id="1-支持了更多的架构和系统">1. 支持了更多的架构和系统</h4><ul><li>支持更多的<strong>架构</strong>：<code class="language-plaintext highlighter-rouge">dyld 2</code> 最初是在 <code class="language-plaintext highlighter-rouge">PowerPC</code> 上发行的，后来又增加了对 <code class="language-plaintext highlighter-rouge">x86</code>, <code class="language-plaintext highlighter-rouge">x86_64</code>, <code class="language-plaintext highlighter-rouge">arm</code>, <code class="language-plaintext highlighter-rouge">arm64</code> 架构的支持。<li>支持更多的<strong>系统</strong>：这个时期发布了 <code class="language-plaintext highlighter-rouge">iOS</code>，<code class="language-plaintext highlighter-rouge">tvOS</code>，和 <code class="language-plaintext highlighter-rouge">watchOS</code> 系统，<code class="language-plaintext highlighter-rouge">dyld</code> 做了大量相关的适配工作。</ul><h4 id="2-提高了安全性">2. 提高了安全性</h4><ul><li><em>Codesigning</em> ：<em>代码签名</em>。<li><em>ASLR (Address Space Layout Randomization)</em> ： <em>地址空间布局随机化</em>，每次加载库时，它可能在不同的地址。<li><em>Bounds checking</em> ：检查 <code class="language-plaintext highlighter-rouge">Mach-O Header</code> 的边界，所以其他人无法用<em>篡改 (malformed)</em> 的二进制文件来做某些类型的<em>连接 (attach)</em> 。</ul><h4 id="3-优化了性能">3. 优化了性能</h4><p>完全用<strong>共享缓存</strong>替代了 prebinding 。下面将简要介绍<em>共享缓存</em>。</p><h3 id="共享缓存-shared-cache">共享缓存 (Shared Cache)</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-2.x-Shared-Cache.jpeg" alt="dyld-2.x-Shared-Cache.jpeg" /></p><p><strong>共享缓存是包含所有系统 dylib 的单个文件。</strong> 它是在 <code class="language-plaintext highlighter-rouge">iOS 3.1</code> 和 <code class="language-plaintext highlighter-rouge">macOS Snow Leopard (10.6)</code> 引入的，并<strong>完全取代了 prebinding</strong> 。</p><p>由于所有的系统 <code class="language-plaintext highlighter-rouge">dylib</code> 被合并成了单个文件，因此系统可以对其做一些优化。</p><h4 id="优化方式">优化方式</h4><h5 id="1-重新排列二进制文件-rearranges-binaries-以提高加载速度">1. 重新排列二进制文件 (Rearranges binaries) 以提高加载速度</h5><p>系统可以<strong>重新排列</strong>这些二进制文件的所有的<em>文本段 (text segments)</em> 和所有的<em>数据段 (data segments)</em> ，重写他们的整个<em>符号表 (symbol tables)</em> ，以减少大小。这样，系统需要在每个进程<em>挂载 (mount)</em> 的<em>区域 (regions)</em> 更少。</p><h5 id="2-预链接动态库-pre-links-dylibs">2. 预链接动态库 (Pre-links dylibs)</h5><p><em>Prelinker</em> 可以<strong>打包二进制段 (pack binary segments)</strong> 来节省内存。开发者不需要做任何改动，就能节省很多内存。在 iOS 系统上，可以在运行时节省 <strong>500MB ~ 1GB</strong> 的内存。</p><h5 id="3-预构建-pre-builds-dyld-和-objc-使用的数据结构">3. 预构建 (Pre-builds) dyld 和 ObjC 使用的数据结构</h5><p><em>预构建 (Pre-builds)</em> <em>dyld</em> 和 <em>ObjC</em> 在运行时使用的数据结构，这样我们就不必在启动时做了。这也节省了很多内存和时间。</p><h4 id="共享缓存的生成方式">共享缓存的生成方式</h4><ul><li>在 macOS 上，它是在本地构建的，当你看到 <em>optimizing system performance</em> 时，就是系统在更新共享缓存。<li>在所有其他的 Apple 系统上，共享缓存是作为系统的一部分发布的。</ul><p>注：从 <em>macOS Big Sur (11.0)</em> 开始，共享缓存也是作为系统的一部分发布的。</p><p>参考：</p><ul><li><a href="https://iphonedev.wiki/index.php/Dyld_shared_cache">https://iphonedev.wiki/index.php/Dyld_shared_cache</a></ul><h3 id="dyld-3-2017">dyld 3 (2017)</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3.jpeg" alt="dyld-3" /></p><p><em>dyld 3</em> 是对<em>动态链接 (dynamic linking)</em> 的完全重新思考。</p><ul><li>2017 年，<em>iOS 11</em> 的系统自带 APP 开始使用 <em>dyld 3</em> ，第三方 APP 还是使用 <em>dyld 2.x</em> 。<li>2019 年，<em>iOS 13</em> 的系统自动 APP 和第三方 APP 都使用 <em>dyld 3</em> 。</ul><p>（注：本文写于 2021年7月，此时已是 <em>iOS 14</em> ）</p><p>下面将详细介绍 <code class="language-plaintext highlighter-rouge">dyld 3</code> 。</p><h2 id="dyld-3-诞生的背景">dyld 3 诞生的背景</h2><h3 id="为什么又重写动态链接器">为什么又重写动态链接器</h3><ol><li>性能：理论上，让 APP 运行起来的<em>最小的任务量</em>包含哪些任务？<li>安全：是否可以有更严格的安全检查并预先设计安全？<li>可测试性和可靠性：能否使 <code class="language-plaintext highlighter-rouge">dyld</code> 更容易测试？</ol><h3 id="无法使用-xctest-测试-dyld-2x-代码的原因">无法使用 XCTest 测试 dyld 2.x 代码的原因</h3><p>由于 <code class="language-plaintext highlighter-rouge">XCTest</code> 依赖于动态链接器的底层功能来将它插入进程，所以无法使用 <code class="language-plaintext highlighter-rouge">XCTest</code> 对 <code class="language-plaintext highlighter-rouge">dyld 2.x</code> 的代码做测试。因此 <code class="language-plaintext highlighter-rouge">dyld</code> 的工程师很难对 <code class="language-plaintext highlighter-rouge">dyld</code> 的<em>安全性</em>和<em>性能</em>做测试。</p><h3 id="dyld-3-的改进">dyld 3 的改进</h3><ul><li>把 <code class="language-plaintext highlighter-rouge">dyld</code> 复杂的操作从<em>进程 (process)</em> 中移出，以<strong>守护进程 (daemon)</strong> 的形式存在。因此，使用 <code class="language-plaintext highlighter-rouge">XCTest</code> 测试 <code class="language-plaintext highlighter-rouge">dyld</code> 的代码也变得很容易了。<li>这使得进程中 <code class="language-plaintext highlighter-rouge">dyld</code> 的其余部分尽可能小，因此也减少了 APP 内的（可被恶意软件利用的）“攻击平台”。<li>另外，这也使 APP 的启动更快了，因为最快的代码就是你从未写过的代码，其次是从未执行的代码。</ul><blockquote><p>原文：The fastest code is code you never write, followed closely by code you almost never execute.<br /> 这让小编想到了在海淀区 Hello World “公园”的建筑上的一句话：No code is faster than no code.</p></blockquote><h2 id="dyld-2-的执行流程">dyld 2 的执行流程</h2><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-2-launch.jpeg" alt="dyld-2-launch.jpeg" class="normal" width="300" /></p><h3 id="1-parse-mach-o-headers--find-dependencies">1. Parse mach-o headers &amp; Find dependencies</h3><p><code class="language-plaintext highlighter-rouge">dyld</code> 会解析 <code class="language-plaintext highlighter-rouge">Mach-O Headers</code> ，并寻找 APP 需要的动态库，然后这些动态库可能依赖了其他动态库，<code class="language-plaintext highlighter-rouge">dyld</code> 就递归地做这个任务，直到获得 APP 的完整的动态库依赖图 (a complete graph of all your dylibs) 。</p><p>平均而言，一个 iOS 应用需要加载 300 ~ 600 个系统动态库，数量较多，因此有相当大的工作量。</p><h3 id="2-map-mach-o-files">2. Map mach-o files</h3><p>这个阶段 <code class="language-plaintext highlighter-rouge">dyld</code> <em>映射 (map)</em> 所有的 <code class="language-plaintext highlighter-rouge">Mach-O</code> 文件到 APP 的<em>地址空间 (address space)</em> 。</p><h3 id="3-perform-symbol-lookups">3. Perform symbol lookups</h3><p>接下来执行<em>符号查找 (symbol lookups)</em> 。比如 APP 内使用了 <code class="language-plaintext highlighter-rouge">printf</code> ，<code class="language-plaintext highlighter-rouge">dyld</code> 就会去系统动态库中查找它的地址，找到后就把这个地址拷贝到 APP 内的一个<em>函数指针 (function pointer)</em> 中。</p><h3 id="4-bind-and-rebase">4. Bind and rebase</h3><p>因为 APP 是在一个随机地址（用了 <code class="language-plaintext highlighter-rouge">ASLR</code> 技术），因此 APP 内的<strong>所有的指针</strong>都必须把这个基地址值加上。</p><h3 id="5-run-initializers">5. Run initializers</h3><p>最后，<code class="language-plaintext highlighter-rouge">dyld</code> 调用 APP 内所有的 <code class="language-plaintext highlighter-rouge">initializer</code> ，完成后就能调用 APP 的 <code class="language-plaintext highlighter-rouge">main()</code> 函数了。</p><h2 id="dyld-2-向-dyld-3-的转变">dyld 2 向 dyld 3 的转变</h2><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-2-to-dyld-3.jpeg" alt="dyld-2-to-dyld-3.jpeg" /></p><p><code class="language-plaintext highlighter-rouge">dyld 3</code> 与 <code class="language-plaintext highlighter-rouge">dyld 2</code> 的主要区别是将大部分功能从<em>进程 (process)</em> 移到了<em>守护进程 (daemon)</em> 。</p><h3 id="1-安全敏感组件">1. 安全敏感组件</h3><p>有安全隐患的阶段：</p><ul><li><strong>Parsing mach-o headers</strong><li><strong>Find dependencies</strong></ul><p>如果 <code class="language-plaintext highlighter-rouge">Mach-O Headers</code> 被篡改了，则可被用来做特定类型的攻击。我们的 APP 中可能使用了 <code class="language-plaintext highlighter-rouge">@rpath</code> ，也就是<em>搜索路径 (search path)</em> ，通过篡改它们或者在正确的位置插入库，就能侵入 APP 。</p><p>因此，<code class="language-plaintext highlighter-rouge">dyld 3</code> 将这部分功能从<em>进程 (process)</em> 移到了<em>守护进程 (daemon)</em> 。</p><h3 id="2-可缓存的部分">2. 可缓存的部分</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3-compare.jpeg" alt="dyld-3-compare.jpeg" /> <em>dyld 2 与 dyld 3 执行流程的对比</em></p><p>可缓存的阶段：</p><ul><li><strong>Parsing mach-o headers</strong><li><strong>Find dependencies</strong><li><strong>Perform symbol lookups</strong></ul><p>除非<em>执行了软件更新</em>或<em>更改了磁盘上的库</em>，否则每次启动时：</p><ol><li>APP 依赖的库不会变。<li>库中的<em>符号 (symbols)</em> 始终处于相同的<em>偏移量 (offset)</em> 。</ol><p>因此，在 <code class="language-plaintext highlighter-rouge">dyld 3</code> 中，将可缓存的阶段挪到了最前面，并将执行结果以一个<em>闭包 (closure)</em> 的形式写入磁盘中，在之后的流程中会用到这个闭包。</p><h2 id="dyld-3-架构简介">dyld 3 架构简介</h2><h3 id="概览dyld-3-由三部分组成">概览：dyld 3 由三部分组成</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3-architecture-overview.jpeg" alt="dyld-3-architecture-overview.jpeg" /></p><p><code class="language-plaintext highlighter-rouge">dyld 3</code> 有三个组件：</p><ol><li>一个<em>进程外 (out-of-process)</em> 的 <code class="language-plaintext highlighter-rouge">mach-o</code> <em>解析器/编译器 (parser/complier)</em><li>一个运行<em>启动闭包</em>的<em>进程内 (in-process)</em> 引擎<li>一个<em>启动闭包</em>缓存服务</ol><p>大多数启动使用缓存，而不必调用<em>进程外</em>的 <code class="language-plaintext highlighter-rouge">mach-o</code> <em>解析器或编译器</em>。</p><p><em>启动闭包</em>比 <code class="language-plaintext highlighter-rouge">mach-o</code> 要简单得多，它们是 <strong>memory map</strong> 文件，因此不需要使用复杂的方式来解析。并且验证<em>启动闭包</em>也很简单。<em>启动闭包</em>就是为速度而生的。</p><p>接下来简要介绍这三个组件。</p><h3 id="1-进程外的-mach-o-解析器编译器">1. 进程外的 mach-o 解析器/编译器</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3-architecture-1.jpeg" alt="dyld-3-architecture-1.jpeg" /></p><p>首先，<code class="language-plaintext highlighter-rouge">dyld 3</code> 包含一个进程外的 <code class="language-plaintext highlighter-rouge">mach-o</code> 解析器/编译器。</p><p>它的主要功能是：</p><ul><li>解析 (resolve) 所有的启动需要的<em>搜索路径 (search path)</em> 、<em>@rpath</em> 、<em>环境变量 (environment variable)</em> ；<li>解析 (parse) 所有的 <code class="language-plaintext highlighter-rouge">mach-o</code> 二进制文件；<li>执行<em>符号查找 (symbol lookup)</em> ；<li>最后，创建一个带有结果的<em>闭包 (closure)</em> 。</ul><p>这部分功能在 <code class="language-plaintext highlighter-rouge">dyld 3</code> 中是一个普通的<em>守护进程</em>，所以 <code class="language-plaintext highlighter-rouge">dyld</code> 团队可以使用普通的测试基础设施。</p><h3 id="2-运行启动闭包的进程内引擎">2. 运行启动闭包的进程内引擎</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3-architecture-2.jpeg" alt="dyld-3-architecture-2.jpeg" /></p><p>然后，<code class="language-plaintext highlighter-rouge">dyld 3</code> 包含一个小型的进程内引擎，也就是说这部分功能会加载到 APP 的进程中，也是最常被使用到的模块。</p><p>它的主要功能是：</p><ul><li>验证启动闭包是否正确；<li>map in 所有的 dylib ；<li><em>Fix-ups</em>: <em>Bind</em> 和 <em>Rebase</em> ；<li>运行所有的 initializer ；<li>跳转到 APP 的 <code class="language-plaintext highlighter-rouge">main()</code> 函数。</ul><p>值得注意的是，在这个过程中再也不需要解析 <code class="language-plaintext highlighter-rouge">mach-o header</code> 或执行<em>符号查找</em>，这使 APP 的启动更快了。</p><h3 id="3-启动闭包缓存服务">3. 启动闭包缓存服务</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3-architecture-3.jpeg" alt="dyld-3-architecture-3.jpeg" /></p><p>最后，<code class="language-plaintext highlighter-rouge">dyld 3</code> 包含一个<em>启动闭包缓存服务 (launch closure caching service)</em> 。</p><p>在 <code class="language-plaintext highlighter-rouge">iOS</code>、<code class="language-plaintext highlighter-rouge">tvOS</code>、<code class="language-plaintext highlighter-rouge">watchOS</code> 中，即使 APP 没有运行过，<code class="language-plaintext highlighter-rouge">启动闭包</code>就已经被预构建了：</p><ul><li><strong>系统 APP</strong> 的<em>启动闭包</em>內建在<em>共享缓存</em>中。<li><strong>第三方 APP</strong> 在安装时或系统升级时构建启动闭包（因为系统升级时，系统动态库可能有变动）。</ul><p>在 <code class="language-plaintext highlighter-rouge">macOS</code> 上，第一次启动 APP 时有所不同，但之后再启动就能使用缓存的启动闭包了：</p><ul><li>On macOS, because you can <strong>side load applications</strong>, the <strong>in-process engine can RPC out to the daemon if necessary on first launch</strong>（???）, and then after that it will be able to use a cached closure just like everything else.</ul><h2 id="为-dyld-3-做准备">为 dyld 3 做准备</h2><h3 id="潜在的问题">潜在的问题</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3-potential-issue.jpeg" alt="dyld-3-potential-issue.jpeg" /></p><p>在切换到 <code class="language-plaintext highlighter-rouge">dyld 3</code> 时，有一些潜在的问题需要注意：</p><ul><li><code class="language-plaintext highlighter-rouge">dyld 3</code> 完全兼容 <code class="language-plaintext highlighter-rouge">dyld 2.x</code> ，<ul><li>但是一些旧 API 在 <code class="language-plaintext highlighter-rouge">dyld 3</code> 上会运行的较慢或者使用回退机制，因此开发者需要避免这种情况。<li>为 <code class="language-plaintext highlighter-rouge">dyld 2.x</code> 做的一些的优化可能已经无效了。</ul><li><code class="language-plaintext highlighter-rouge">dyld 3</code> 有<em>更严格的链接语义 (Stricter linking semantics)</em> ，<ul><li>对于旧的二进制，会兼容旧的行为；<li>对于新的二进制，会导致 <em>linker error</em> 。</ul></ul><h3 id="__data-中未对齐的指针">__DATA 中未对齐的指针</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3-unaligned-pointer-1.jpeg" alt="dyld-3-unaligned-pointer-1.jpge" /></p><p>假如 APP 中有一个<em>全局</em>的数据结构指向一个函数或者另一个<em>全局</em>的数据结构，那么这个指针需要在 APP 启动前被 <em>fix up</em> ，并且这个指针必须对齐、以获得最佳的性能。</p><p><em>fix up</em> 未对齐的指针要复杂得多：</p><ul><li>未对齐的指针会<em>跨越 (span)</em> 多个页面，这可能会导致更多的<em>页面错误 (page fault)</em> 和其他问题<li>而且它们可能存在与<em>多处理器 (multiprocessor)</em> 相关的<em>原子性问题 (atomicity issues)</em></ul><p><em>静态连接器 (static linker)</em> 会对这种情况发出一个 <em>ld warning</em> ：指针没有在某地址上对齐。这通常是对应数据段的地址。</p><p>下面将给出一个 C 中未对齐指针的案例。Swift 不允许这么做，因此，请多使用 Swift 。</p><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3-unaligned-pointer-2.jpeg" alt="dyld-3-unaligned-pointer-2.jpge" /></p><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3-unaligned-pointer-3.jpeg" alt="dyld-3-unaligned-pointer-3.jpge" /></p><h3 id="急切的符号解析">急切的符号解析</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3-eager-symbol-resolution-1.jpeg" alt="dyld-3-eager-symbol-resolution-1.jpeg" class="normal" width="600" /></p><h4 id="1-dyld-2-执行惰性的符号解析-lazy-symbol-resolution">1. dyld 2 执行惰性的符号解析 (Lazy symbol resolution)</h4><p>在 <code class="language-plaintext highlighter-rouge">dyld 2</code> 中，如果在启动时就查找所有的符号，代价太高。因此 <code class="language-plaintext highlighter-rouge">dyld 2</code> 执行的是<em>惰性的符号解析</em>。</p><ul><li>每个符号在第一次被调用时执行符号查找 。<li>如果符号缺失，将在首次调用时导致 crash 。</ul><p>比如，APP 内第一次调用 <code class="language-plaintext highlighter-rouge">printf</code> 函数时，最初它的函数指针不是指向 <code class="language-plaintext highlighter-rouge">printf</code> 的实现，而是指向 <code class="language-plaintext highlighter-rouge">dyld</code> 中的一个函数，这个 <code class="language-plaintext highlighter-rouge">dyld</code> 的函数会返回指向 <code class="language-plaintext highlighter-rouge">printf</code> 实现的指针。第二次调用 <code class="language-plaintext highlighter-rouge">printf</code> 时，就直接调用它的实现了。</p><h4 id="2-dyld-3-执行急切的符号解析-eager-symbol-resolution">2. dyld 3 执行急切的符号解析 (Eager symbol resolution)</h4><p>在 <code class="language-plaintext highlighter-rouge">dyld 3</code> 中，由于符号查找的结果缓存在启动闭包中，所以符号查找非常快，可以在启动时就检查所有的符号。也就是说 <code class="language-plaintext highlighter-rouge">dyld 3</code> 执行<em>急切的符号解析</em>。</p><h4 id="3-dyld-3-对符号缺失的兼容">3. dyld 3 对符号缺失的兼容</h4><p>由上述内容可知，<code class="language-plaintext highlighter-rouge">dyld 2</code> 和 <code class="language-plaintext highlighter-rouge">dyld 3</code> 对<strong>符号缺失</strong>的反应不同。当缺失某个符号时：</p><ul><li>在使用 <code class="language-plaintext highlighter-rouge">dyld 2</code> 的系统上，APP 可成功启动，但会在第一次调用缺失的符号时 crash 。<li>在使用 <code class="language-plaintext highlighter-rouge">dyld 3</code> 的系统上，APP 无法正常启动。</ul><p><code class="language-plaintext highlighter-rouge">dyld 3</code> 目前对这种情况做了兼容，使得其行为与 <code class="language-plaintext highlighter-rouge">dyld 2</code> 保持一致，这样可以保障缺失符号的旧版 APP 能正常启动。</p><p>其兼容方法是在 <code class="language-plaintext highlighter-rouge">dyld 3</code> 中内置了一个会自动 crash 的符号，如果 APP 启动时未找到符号，就将其绑定到这个符号上，因此，第一次调用时会 crash 。</p><p>需要注意的是，这是当前 <code class="language-plaintext highlighter-rouge">dyld 3</code> 的兼容行为，未来可能会强制所有的符号解析在前面执行。也就是说，启动时如果缺失符号就会 crash ，这使得开发者能在开发时就发现代码的问题。</p><h4 id="4-linker-flag--bind_at_load">4. Linker Flag: -bind_at_load</h4><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-3-eager-symbol-resolution-2.jpeg" alt="dyld-3-eager-symbol-resolution-2.jpeg" /></p><p>在使用 <code class="language-plaintext highlighter-rouge">dyld 2</code> 的系统上，可以在 <strong>Other Linker Flags</strong> 中添加 <code class="language-plaintext highlighter-rouge">-bind_at_load</code> 参数，可以强制 <code class="language-plaintext highlighter-rouge">dyld 2</code> 在启动时加载所有符号，这样可以提前发现问题，为 <code class="language-plaintext highlighter-rouge">dyld 3</code> 的到来做好准备。</p><p>要注意的是，由于 <code class="language-plaintext highlighter-rouge">-bind_at_load</code> 会导致启动很慢，因此只能在 Debug build 中使用，不要在 Release build 中使用。</p><h3 id="dlopen--dlsym--dladdr">dlopen() / dlsym() / dladdr()</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-dlopen-dlsym-dladdr.jpeg" alt="dyld-dlopen-dlsym-dladdr.jpeg" class="normal" width="600" /></p><h3 id="dlclose">dlclose()</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-dlclose.jpeg" alt="dyld-dlclose.jpeg" class="normal" width="600" /></p><h3 id="all_image_infos">all_image_infos</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-all_image_infos.jpeg" alt="dyld-all_image_infos.jpeg" class="normal" width="500" /></p><h3 id="最佳实践">最佳实践</h3><p><img data-proofer-ignore data-src="/images/WWDC/2017/413-App-Startup-Time-dyld/dyld-best-practices.jpeg" alt="dyld-best-practices.jpeg" /></p><h2 id="应用场景">应用场景</h2><h3 id="prepare-your-app-for-prewarming">Prepare Your App for Prewarming</h3><ul><li><a href="https://sourcediving.com/solving-mysterious-logout-issues-on-ios-15-8b818c089466">Solving Mysterious Logout Issues on iOS 15</a><li>Apple Document<ul><li><a href="https://developer.apple.com/documentation/uikit/app_and_environment/responding_to_the_launch_of_your_app/about_the_app_launch_sequence#3894431">About the App Launch Sequence</a><li><a href="https://developer.apple.com/documentation/metrickit">MetricKit</a></ul></ul><h2 id="reference">Reference</h2><ul><li>整理的字幕：<a href="https://github.com/Bob-Playground/WWDC-Stuff/blob/master/2017/413-App-Startup-Time-Past-Present-and-Future/Transcript-Edited.md">https://github.com/Bob-Playground/WWDC-Stuff/blob/master/2017/413-App-Startup-Time-Past-Present-and-Future/Transcript-Edited.md</a><li>原始的 PDF：<a href="https://devstreaming-cdn.apple.com/videos/wwdc/2017/413fmx92zo14voet8/413/413_app_startup_time_past_present_and_future.pdf?dl=1">https://devstreaming-cdn.apple.com/videos/wwdc/2017/413fmx92zo14voet8/413/413_app_startup_time_past_present_and_future.pdf?dl=1</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E6%94%BB%E5%9F%8E%E7%8B%AE/'>攻城狮</a>, <a href='/categories/wwdc/'>WWDC</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/wwdc17/" class="post-tag no-text-decoration" >WWDC17</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >iOS</a> <a href="/tags/app-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-tag no-text-decoration" >APP 性能优化</a> <a href="/tags/app-%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/" class="post-tag no-text-decoration" >APP 启动优化</a> <a href="/tags/dyld2/" class="post-tag no-text-decoration" >dyld2</a> <a href="/tags/dyld3/" class="post-tag no-text-decoration" >dyld3</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> <span class="text-muted small">-- Missing configuration options! --</span></div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <i class="fa-fw fas fa-link small" onclick="copyLink('', '')" data-toggle="tooltip" data-placement="top" title=""> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/App-Startup-Time-dyld/">【WWDC17】优化 APP 启动（dyld 2 -> dyld 3）</a><li><a href="/posts/forceFullDesktopBar/">在 macOS 的 Mission Control 中展示完整的桌面预览</a><li><a href="/posts/Optimizing-App-Startup-Time/">[WIP]【WWDC16】优化 App 启动（基于 dyld 2）</a><li><a href="/posts/Objective-C-Runtime-Changes-in-iOS-14/">【iOS 14】Objective-C Runtime 的优化</a><li><a href="/posts/Optimizing-App-Launch/">【WWDC19】优化 APP 启动（基于 dyld 3）</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/app-%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/">APP 启动优化</a> <a class="post-tag" href="/tags/app-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">APP 性能优化</a> <a class="post-tag" href="/tags/objective-c-runtime/">Objective-C Runtime</a> <a class="post-tag" href="/tags/proxy/">Proxy</a> <a class="post-tag" href="/tags/shadowsocks/">Shadowsocks</a> <a class="post-tag" href="/tags/%E5%85%B3%E4%BA%8E%E5%86%99%E5%8D%9A%E5%AE%A2/">关于写博客</a> <a class="post-tag" href="/tags/app-%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/">App 启动优化</a> <a class="post-tag" href="/tags/app-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">App 性能优化</a> <a class="post-tag" href="/tags/class-rw-ext-t/">class_rw_ext_t</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Optimizing-App-Launch/"><div class="card-body"> <span class="timeago small" >Jun 6<i class="unloaded">2021-06-06T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>【WWDC19】优化 APP 启动（基于 dyld 3）</h3><div class="text-muted small"><p> 目录 前言 1. 什么是启动 暖场小故事 为什么启动很重要 1. 第一印象 2. 可以反映整体的代码质量 3. 性能 启动的类型 1. 冷启动 2. 热启动 ...</p></div></div></a></div><div class="card"> <a href="/posts/LLDB-beyond-po/"><div class="card-body"> <span class="timeago small" >Mar 2<i class="unloaded">2021-03-02T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>po、p、v 命令；LLDB 的自定义 Data Formatter；在 LLDB 中使用 Python 脚本</h3><div class="text-muted small"><p> 目录 前言 LLDB 常用命令 po、p、v LLDB 常用命令一：po po 的常见用法 po 是 expression 命令的 alias 创建自定义的 alias po 的原理 LLDB 常用命令二：p ...</p></div></div></a></div><div class="card"> <a href="/posts/Objective-C-Runtime-Changes-in-iOS-14/"><div class="card-body"> <span class="timeago small" >May 17<i class="unloaded">2021-05-17T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>【iOS 14】Objective-C Runtime 的优化</h3><div class="text-muted small"><p> 目录 前言 新特性的适配 1. 新增类型：class_rw_ext_t class_ro_t Clean memory &amp; Dirty memory class_rw_t 从 class_rw_t 中拆分出 class_rw_ext_t 实例 macOS...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Optimizing-App-Launch/" class="btn btn-outline-primary" prompt="previous"><p>【WWDC19】优化 APP 启动（基于 dyld 3）</p></a> <a href="/posts/Optimizing-App-Startup-Time/" class="btn btn-outline-primary" prompt="next"><p>[WIP]【WWDC16】优化 App 启动（基于 dyld 2）</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/Huang-Libo">Huang Libo</a>. <span class="text-muted">-- Missing configuration options! --</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/app-%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/">APP 启动优化</a> <a class="post-tag" href="/tags/app-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">APP 性能优化</a> <a class="post-tag" href="/tags/objective-c-runtime/">Objective C Runtime</a> <a class="post-tag" href="/tags/proxy/">Proxy</a> <a class="post-tag" href="/tags/shadowsocks/">Shadowsocks</a> <a class="post-tag" href="/tags/%E5%85%B3%E4%BA%8E%E5%86%99%E5%8D%9A%E5%AE%A2/">关于写博客</a> <a class="post-tag" href="/tags/app-%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/">App 启动优化</a> <a class="post-tag" href="/tags/app-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">App 性能优化</a> <a class="post-tag" href="/tags/class-rw-ext-t/">class_rw_ext_t</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://Huang-Libo.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
